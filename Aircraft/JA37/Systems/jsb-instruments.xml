<?xml version="1.0"?>

<system name="instruments">
    <channel execrate="4" name="accelerometer">
        <pure_gain name="instruments/g-force">
            <input>accelerations/a-pilot-z-ft_sec2</input>
            <gain>-0.031081</gain>
            <output>/ja37/accelerations/pilot-G</output>
        </pure_gain>

        <pure_gain name="instruments/g-force-norm">
            <input>instruments/g-force</input>
            <gain>0.01</gain>
            <output>/ja37/accelerations/pilot-G-norm</output>
        </pure_gain>
        
        <!-- accelerometer animation -->
        <lag_filter name="instruments/accelerometer">
            <input>instruments/g-force</input>
            <c1>5</c1>
            <clipto>
                <min>-2</min>
                <max>9</max>
            </clipto>
            <output>/instrumentation/accelerometer/g-force-indicated</output>
        </lag_filter>

        <switch name="instruments/max-g-raw">
            <default value="instruments/max-g-raw"/>
            <test logic="OR" value="instruments/accelerometer">
                instruments/accelerometer gt instruments/max-g-raw
                /instrumentation/accelerometer/reset-button == 1
                <!-- hack: high g-forces are registered during initialization, reset them -->
                sim-time-sec lt 1
            </test>
        </switch>

        <actuator name="instruments/max-g">
            <input>instruments/max-g-raw</input>
            <rate_limit>20</rate_limit>
            <clipto>
                <min>-2</min>
                <max>9</max>
            </clipto>
            <output>/instrumentation/accelerometer/g-force-max</output>
        </actuator>

        <!-- g-force sounds -->
        <switch name="names/sound/max-pos-g">
            <default value="/ja37/sound/loadfactor-percent"/>
            <test logic="OR" value="110">
              /instrumentation/terrain-override == 1
            </test>
            <output>/ja37/sound/loadfactor-percent-used</output>
        </switch>
        
        <fcs_function name="names/instruments/max-positive-g-set">
            <function>
                    <product>
                        <v>0.01</v>                        
                        <p>/ja37/sound/loadfactor-percent-used</p>
                        <p>/limits/max-positive-g</p>
                    </product>
            </function>
            <output>/limits/max-positive-g-set</output>
        </fcs_function>
        
        <fcs_function name="names/instruments/sound-g-force-norm">
            <function>
                    <quotient>
                        <p>/ja37/accelerations/pilot-G-lag</p>
                        <p>/limits/max-positive-g-set</p>
                    </quotient>
            </function>
            <output>/ja37/sound/pilot-G-norm</output>
        </fcs_function>

        <!--<washout_filter name="names/instruments/g-force-damped">
          <input> /ja37/accelerations/pilot-G </input>
          <c1> 1 </c1>
          <output> /ja37/accelerations/pilot-G-damped </output>
        </washout_filter>-->

        <kinematic name="names/instruments/g-force-norm-damped">
            <input>/ja37/accelerations/pilot-G-norm</input>
            <traverse>
                <setting>
                    <position>-1</position>
                    <time>0.0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>10</time>
                </setting>
            </traverse>
            <clipto>
                <min>-1</min>
                <max>1</max>
            </clipto>
            <output> /ja37/accelerations/pilot-G-norm-damped </output>
        </kinematic>

        <fcs_function name="names/instruments/g-force-damped">
            <function>
                    <product>
                        <p>/ja37/accelerations/pilot-G-norm-damped</p>
                        <v>100</v>
                    </product>
            </function>
            <output>/ja37/accelerations/pilot-G-damped</output>
        </fcs_function>
    </channel>


    <channel execrate="4" name="engine-instruments">
        <!-- Engine pressure ratio -->
        <fcs_function name="propulsion/engine/mil-rate">
            <function>
                <!-- looked in JSBSim source code to find this formula for milthrust,
                     for the AJ I use also JA max mil value as its only a factor -->
                <product>
                    <table>
                        <independentVar lookup="row">propulsion/engine/n2</independentVar>
                        <tableData>
                             56.9 0
                             57   1
                        </tableData>
                    </table>
                    <sum>
                        <product>
                            <p>propulsion/engine/IdleThrust</p>
                            <v>72100</v>
                        </product>
                        <product>
                            <product>
                                <difference>
                                    <v>72100</v>
                                    <product>
                                        <p>propulsion/engine/IdleThrust</p>
                                        <v>72100</v>
                                    </product>
                                </difference>
                                <p>propulsion/engine/MilThrust</p>
                            </product>
                            <quotient>
                                <difference>
                                    <p>propulsion/engine/n2</p>
                                    <v>57</v>
                                </difference>
                                <v>43</v>
                            </quotient>
                            <quotient>
                                <difference>
                                    <p>propulsion/engine/n2</p>
                                    <v>57</v>
                                </difference>
                                <v>43</v>
                            </quotient>
                        </product>
                    </sum>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/p7-p2">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/mil-rate</independentVar>
                    <tableData>
                         1650     1.00 <!-- extrapolated -->
                         3000     1.02
                        72100     2.06 <!-- AJS-37 manual part 1, engine section -->
                       115000    2.705 <!-- extrapolated -->
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="instruments/engine/epr-raw">
            <default value="propulsion/engine/p7-p2"/>
            <test value="/engines/engine/epr-gauge">
                /ja37/elec/ac-bus-main-bool == 0
            </test>
        </switch>

        <actuator name="instruments/engine/epr">
            <input>instruments/engine/epr-raw</input>
            <rate_limit>4</rate_limit>
            <clipto>
                <min>1</min>
                <max>3</max>
            </clipto>
            <output>/engines/engine/epr-gauge</output>
        </actuator>

        <!-- RPM -->
        <switch name="instruments/engine/rpm-raw">
            <default value="propulsion/engine/n2"/>
            <test value="/engines/engine/rpm-gauge">
              /ja37/elec/ac-bus-main-bool == 0
            </test>
        </switch>

        <actuator name="instruments/engine/rpm">
            <input>instruments/engine/rpm-raw</input>
            <rate_limit>200</rate_limit>
            <clipto>
                <min>0</min>
                <max>110</max>
            </clipto>
            <output>/engines/engine/rpm-gauge</output>
        </actuator>
    </channel>


    <channel execrate="4" name="altimeters">
        <pure_gain name="instruments/altimeter/altitude-m">
            <input>/instrumentation/altimeter/indicated-altitude-ft</input>
            <gain>0.3048</gain>
            <output>/instrumentation/altimeter/indicated-altitude-meter</output>
        </pure_gain>

        <pure_gain name="instruments/altimeter-backup/altitude-m">
            <input>/instrumentation/altimeter[1]/indicated-altitude-ft</input>
            <gain>0.3048</gain>
            <output>/instrumentation/altimeter[1]/indicated-altitude-meter</output>
        </pure_gain>
    </channel>

    <channel execrate="4" name="radar-altimeter">
        <switch name="instruments/radar-altimeter/enabled">
            <default value="1"/>
            <test logic="OR" value="0">
                /instrumentation/radar-altimeter/serviceable == 0
                /ja37/elec/dc-bus-main-bool == 0
                /controls/altimeter-radar == 0
                gear/unit[1]/WOW == 1
                /instrumentation/attitude-indicator/indicated-pitch-deg gt 45
                /instrumentation/attitude-indicator/indicated-pitch-deg lt -45
                /instrumentation/attitude-indicator/indicated-roll-deg gt 45
                /instrumentation/attitude-indicator/indicated-roll-deg lt -45
            </test>
            <output>/instrumentation/radar-altimeter/enabled</output>
        </switch>

        <pure_gain name="instruments/radar-altimeter/radar-altitude-m">
            <input>/instrumentation/radar-altimeter/radar-altitude-ft</input>
            <gain>0.3048</gain>
            <output>/instrumentation/radar-altimeter/radar-altitude-m</output>
        </pure_gain>

        <!-- Indicates if the radar altimeter signal is good enough for use by flight computer.
             If false, flight computer should do as if no signal is received -->
        <switch name="instruments/radar-altimeter/ready">
            <default value="1"/>
            <test logic="OR" value="0">
                instruments/radar-altimeter/enabled == 0
                instruments/radar-altimeter/radar-altitude-m > /instrumentation/radar-altimeter/max-usable-altitude-m
                /instrumentation/attitude-indicator/indicated-pitch-deg gt 40
                /instrumentation/attitude-indicator/indicated-pitch-deg lt -40
                /instrumentation/attitude-indicator/indicated-roll-deg gt 40
                /instrumentation/attitude-indicator/indicated-roll-deg lt -40
            </test>
            <output>/instrumentation/radar-altimeter/ready</output>
        </switch>
    </channel>

    <channel execrate="4" name="airspeed-indicators">
        <pure_gain name="instruments/airspeed/airspeed-kmh">
            <input>/instrumentation/airspeed-indicator/indicated-speed-kt</input>
            <gain>1.852</gain>
            <output>/instrumentation/airspeed-indicator/indicated-speed-kmh</output>
        </pure_gain>

        <switch name="instruments/airspeed/mach-indicator-raw">
            <default value="/instrumentation/airspeed-indicator/indicated-mach"/>
            <test value="/instrumentation/airspeed-indicator/mach-indicator">
                /ja37/elec/ac-bus-main-bool == 0
            </test>
        </switch>

        <actuator name="instruments/airspeed/mach-indicator">
            <input>instruments/airspeed/mach-indicator-raw</input>
            <rate_limit>0.5</rate_limit>
            <clipto>
                <min>0</min>
                <max>2.5</max>
            </clipto>
            <output>/instrumentation/airspeed-indicator/mach-indicator</output>
        </actuator>

        <actuator name="instruments/airspeed/power-flag">
            <input>/ja37/elec/ac-bus-main-bool</input>
            <rate_limit>10</rate_limit>
            <output>/instrumentation/airspeed-indicator/power-flag</output>
        </actuator>

        <pure_gain name="instruments/airspeed-backup/airspeed-kmh">
            <input>/instrumentation/airspeed-indicator[1]/indicated-speed-kt</input>
            <gain>1.852</gain>
            <output>/instrumentation/airspeed-indicator[1]/indicated-speed-kmh</output>
        </pure_gain>
    </channel>


    <channel execrate="4" name="heading-indicators">
        <pure_gain name="instruments/heading-backup/gyro-power">
            <input>/ja37/elec/ac-bus-main-norm</input>
            <gain>5</gain>
            <output>/instrumentation/heading-indicator[1]/power</output>
        </pure_gain>
    </channel>


    <channel execrate="4" name="attitude-indicators">
        <pure_gain name="instruments/attitude-backup/gyro-power">
            <input>/ja37/elec/ac-bus-main-norm</input>
            <gain>5</gain>
            <output>/instrumentation/attitude-indicator[1]/power</output>
        </pure_gain>

        <actuator name="instruments/attitude-backup/power-flag">
            <input>/ja37/elec/ac-bus-main-bool</input>
            <rate_limit>10</rate_limit>
            <output>/instrumentation/attitude-indicator[1]/power-flag</output>
        </actuator>
    </channel>


    <channel execrate="4" name="waypoint-indicators">
        <!-- waypoint bearing indicator -->
        <summer name="instruments/waypoint/bearing-deg-rel">
            <input>/autopilot/route-manager/wp/bearing-deg</input>
            <input>-/instrumentation/heading-indicator/indicated-heading-deg</input>
        </summer>

        <switch name="instruments/waypoint/bearing-index-goal">
            <test logic="OR" value="/instrumentation/waypoint-indicator/bearing-index">
                /ja37/elec/ac-bus-main-bool == 0
                /instrumentation/heading-indicator/serviceable == 0
            </test>
            <test value="0">
                /autopilot/route-manager/active == 0
            </test>
            <default value="instruments/waypoint/bearing-deg-rel"/>
            <output>/instrumentation/waypoint-indicator/bearing-index-goal</output>
        </switch>
        <!-- the rest is done in instruments-rules.xml,
             because property rules are easier to use for cyclic values
        -->

        <!-- waypoint distance indicator -->
        <pure_gain name="instruments/waypoint/distance-km">
          <input>/autopilot/route-manager/wp/dist</input>
          <gain>1.852</gain>
          <output>/autopilot/route-manager/wp/dist-km</output>
        </pure_gain>

        <!-- Nordic miles = 10km -->
        <pure_gain name="instruments/waypoint/distance-mil">
            <input>instruments/waypoint/distance-km</input>
            <gain>0.1</gain>
        </pure_gain>

        <switch name="instruments/waypoint/distance-unit">
            <default value="0"/> <!-- km -->
            <test logic="AND" value="1"> <!-- mil -->
                /ja37/elec/ac-bus-main-bool == 1
                /autopilot/route-manager/active == 1
                instruments/waypoint/distance-km gt 40
            </test>
        </switch>

        <switch name="instruments/waypoint/distance-needle-raw">
            <test value="/instrumentation/waypoint-indicator/distance-needle">
                /ja37/elec/ac-bus-main-bool == 0
            </test>
            <test value="-5"><!-- Hides the needle -->
                /autopilot/route-manager/active == 0
            </test>
            <test value="instruments/waypoint/distance-mil">
                instruments/waypoint/distance-unit == 1
            </test>
            <default value="instruments/waypoint/distance-km"/>
            <clipto>
                <min>-5</min>
                <max>40</max>
            </clipto>
        </switch>

        <actuator name="instruments/waypoint/distance-needle">
            <input>instruments/waypoint/distance-needle-raw</input>
            <rate_limit>80</rate_limit>
            <clipto>
                <min>-5</min>
                <max>40</max>
            </clipto>
            <output>/instrumentation/waypoint-indicator/distance-needle</output>
        </actuator>

        <actuator name="instruments/waypoint/distance-unit-flag">
            <input>instruments/waypoint/distance-unit</input>
            <rate_limit>10</rate_limit>
            <output>/instrumentation/waypoint-indicator/distance-unit-flag</output>
        </actuator>
    </channel>


    <channel name="aoa-indicator">
        <switch name="instruments/aoa/indicator-raw">
            <default value="aero/alpha-deg"/>
            <test value="-4">
                /ja37/elec/dc-bus-main-bool == 0
            </test>
            <test value="/instrumentation/attitude-indicator/indicated-pitch-deg">
                gear/unit[0]/WOW == 1
            </test>
        </switch>

        <actuator name="instruments/aoa/indicator">
            <input>instruments/aoa/indicator-raw</input>
            <rate_limit>100</rate_limit>
            <clipto>
                <min>-4</min>
                <max>30</max>
            </clipto>
            <output>/instrumentation/aoa-indicator/indicated-aoa</output>
        </actuator>
    </channel>


    <channel execrate="4" name="chronometer">
        <!-- Control property /instrumentation/clock/chronometer-state
             has 3 states:
             - 0: reset to 0
             - 1: running
             - 2: stopped
        -->
        <summer name="instruments/clock/chrono-ref-feedback">
            <input>sim-time-sec</input>
            <input>-/instrumentation/clock/chronometer-time-sec</input>
        </summer>

        <switch name="instruments/clock/chrono-ref-sec">
            <default value="instruments/clock/chrono-ref-feedback"/>
            <!-- When the chrono starts running (state=1), sample reference time -->
            <test logic="AND" value="instruments/clock/chrono-ref-sec">
                /instrumentation/clock/chronometer-state == 1
                <!-- hack: prevent running at initialization to force reading chronometer-time-sec -->
                sim-time-sec gt 0.1
            </test>
        </switch>

        <summer name="instruments/clock/chrono-ref-diff">
            <input>sim-time-sec</input>
            <input>-instruments/clock/chrono-ref-sec</input>
        </summer>

        <switch name="instruments/clock/chrono-time-sec">
            <default value="/instrumentation/clock/chronometer-time-sec"/>
            <test value="0">
                /instrumentation/clock/chronometer-state == 0
            </test>
            <test value="instruments/clock/chrono-ref-diff">
                /instrumentation/clock/chronometer-state == 1
            </test>
            <output>/instrumentation/clock/chronometer-time-sec</output>
        </switch>

        <actuator name="instruments/clock/chrono-needle-pos">
            <input>instruments/clock/chrono-time-sec</input>
            <rate_limit>100</rate_limit>
            <output>/instrumentation/clock/chronometer-needle-pos-sec</output>
        </actuator>
    </channel>


    <channel execrate="4" name="fuel">
        <pure_gain name="instruments/fuel/true-ratio">
            <input>/consumables/fuel/total-fuel-norm</input>
            <gain>/instrumentation/fuel/indicated-ratio-factor</gain>
        </pure_gain>

        <switch name="instruments/fuel/ratio">
            <default value="instruments/fuel/true-ratio"/>
            <test value="0">
              /ja37/elec/ac-bus-main-bool == 0
            </test>
            <output>/instrumentation/fuel/ratio</output>
        </switch>

        <switch name="instruments/fuel/needle-raw">
            <default value="instruments/fuel/ratio"/>
            <test value="/instrumentation/fuel/needle">
              /ja37/elec/ac-bus-main-bool == 0
            </test>
        </switch>

        <actuator name="instruments/fuel/needle">
            <input>instruments/fuel/needle-raw</input>
            <rate_limit>2</rate_limit>
            <clipto>
                <min>0</min>
                <max>1.4</max>
            </clipto>
            <output>/instrumentation/fuel/needle</output>
        </actuator>
    </channel>


    <channel execrate="4" name="instruments">

        <switch name="systems/ins/time-steady">
            <default value="sim-time-sec"/>
            <test logic="AND" value="sim-time-sec">
                /ja37/avionics/button-snabbresn == 1
            </test>
            <test logic="AND" value="systems/ins/time-steady">
                /ja37/elec/ac-bus-main-bool == 1
                /ja37/elec/dc-bus-main-bool == 1
                /ja37/avionics/ins-cmd == 1
            </test>
            <test logic="AND" value="-1000">
                /ja37/avionics/init-done == 1
                sim-time-sec lt 300
            </test>
        </switch>

        <fcs_function name="systems/ins/time-init">
            <function>
                <sum>
                    <p>systems/ins/time-steady</p>
                    <v>140</v>
                </sum>
            </function>
        </fcs_function>
        
        <switch name="systems/ins/init">
            <default value="0"/>
            <test logic="AND" value="1">
                /ja37/elec/dc-bus-main-bool == 1
                sim-time-sec le systems/ins/time-init
                /ja37/avionics/ins-cmd == 1
            </test>
            <output>/ja37/avionics/ins-init</output>
        </switch>

        <switch name="systems/ins/running">
            <default value="0"/>
            <test logic="AND" value="1">
                /ja37/elec/dc-bus-main-bool == 1
                /ja37/avionics/ins-init == 0
                /ja37/avionics/ins-cmd == 1
                sim-time-sec gt systems/ins/time-init
            </test>
            <output>/ja37/avionics/ins</output>
        </switch>

        <switch name="systems/gps/time-steady">
            <default value="sim-time-sec"/>
            <test logic="AND" value="systems/gps/time-steady">
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
        </switch>

        <fcs_function name="systems/gps/time-bit">
            <function>
                <sum>
                    <p>systems/gps/time-steady</p>
                    <v>10</v>
                </sum>
            </function>
        </fcs_function>

        <fcs_function name="systems/gps/time-init">
            <function>
                <sum>
                    <p>systems/gps/time-steady</p>
                    <v>40</v>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/gps/bit">
            <default value="0"/>
            <test logic="AND" value="1">
                sim-time-sec lt systems/gps/time-bit
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
            <output>/ja37/avionics/gps-bit</output>
        </switch>

        <switch name="systems/gps/init">
            <default value="0"/>
            <test logic="AND" value="1">
                sim-time-sec lt systems/gps/time-init
                systems/gps/bit == 0
                /ja37/avionics/gps-cmd == 1
                /ja37/navigation/gps-installed == 1
            </test>
            <output>/ja37/avionics/gps-init</output>
        </switch>

        <switch name="systems/gps/nav">
            <default value="0"/>
            <test logic="OR" value="1">
                sim-time-sec gt systems/gps/time-init
            </test>
            <output>/ja37/avionics/gps-nav</output>
        </switch>


        <!-- used for animating nozzle indicator -->

        <fcs_function name="names/throttle/nozzle-zone">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/zone-scaled</independentVar>
                    <tableData>
                        0.00       0.15
                        0.25       0.38
                        0.50       0.60
                        1.00       1.00
                    </tableData>
                </table>
            </function>
            <output>propulsion/engine/zone-instr</output>
        </fcs_function>

        <switch name="names/throttle/nozzle-direct">
            <default value="propulsion/engine/zone-instr"/>
            <test logic="OR" value="0">
              /ja37/elec/dc-bus-main-bool == 0
            </test>
            <test logic="OR" value="/engines/engine/nozzle-pos-norm">
              propulsion/engine/zone == 0
              propulsion/engine/augmentation == 0
            </test>
            <output>propulsion/engine/nozzle-direct</output>
        </switch>

        <lag_filter name="names/throttle/nozzle">
            <input> propulsion/engine/nozzle-direct </input>
            <c1> 5 </c1>
            <output>propulsion/engine/nozzle</output>
        </lag_filter>


        
        <fcs_function name="systems/sound/alpha-limit-low-ja">
            <description>When 3hz tone comes</description>
            <function>
                <table>
                    <independentVar lookup="row">/position/altitude-ft</independentVar>
                    <tableData>
                        32808  17.00 
                        41010  14.00
                    </tableData>
                </table>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/sound/alpha-limit-low-aj">
            <description>When 3hz tone comes, guesses</description>
            <function>
                <table>
                    <independentVar lookup="row">/position/altitude-ft</independentVar>
                    <tableData>
                        32808  14.00
                        41010  11.00
                    </tableData>
                </table>
            </function>
        </fcs_function>
        
        <switch name="systems/sound/alpha-limit-low">
            <default value="systems/sound/alpha-limit-low-ja"/>
            <test logic="AND" value="systems/sound/alpha-limit-low-aj">
                /ja37/systems/variant gt 0
            </test>
        </switch>
        
        <fcs_function name="systems/sound/alpha-limit-medium">
            <function>
                    <sum>
                        <p>systems/sound/alpha-limit-low</p>
                        <v>3</v>
                    </sum>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/sound/alpha-limit-high">
            <function>
                    <sum>
                        <p>systems/sound/alpha-limit-low</p>
                        <v>6</v>
                    </sum>
            </function>
        </fcs_function>


        <!-- The ratio between N2 and N1 is approx 1:0.7184 -->

        <fcs_function name="propulsion/engine/aj37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0        0.00
                       59.0      120.83
                       74.0      151.33
                       93.3      190.83
                       96.5      197.50
                       97.3      199.17
                      100.0      204.63
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/ja37-n2-rpm_r-s">
            <function>
                <table>
                    <independentVar lookup="row">propulsion/engine/n2</independentVar>
                    <tableData>
                        0.0         0
                       57.0       118
                       70.5       149
                       88.5       181
                       93.9       192
                       94.8       194
                      100.0       204.6
                    </tableData>
                </table>
            </function>
        </fcs_function>

        <switch name="propulsion/engine/n2-rpm_r-s">
            <default value="0"/>
            <test logic="OR" value="propulsion/engine/ja37-n2-rpm_r-s">
                /ja37/systems/variant == 0
            </test>
            <test logic="OR" value="propulsion/engine/aj37-n2-rpm_r-s">
                /ja37/systems/variant gt 0
            </test>
        </switch>

        <fcs_function name="propulsion/engine/n2-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n2-rpm_r-s</property>
                    <value>60</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-min">
            <function>
                <product>
                    <property>propulsion/engine/n1</property>
                    <value>88</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/n1-rpm_r-s">
            <function>
                <quotient>
                    <property>propulsion/engine/n1-rpm_r-min</property>
                    <value>60</value>
                </quotient>
            </function>
        </fcs_function>

        <fcs_function name="propulsion/engine/outlet-temperature-degc">
            <function>
                <quotient>
                    <difference>
                        <property>/engines/engine/egt-degf</property>
                        <value>32</value>
                    </difference>
                    <value>1.8</value>
                </quotient>
                <!--          <sum>
            <table>
              <independentVar lookup="row">propulsion/engine/thrust-lbs</independentVar>
              <tableData>
                  0.0         0
              35000.0       675
              </tableData>
            </table>
            <property>/environment/temperature-degc</property>
          </sum>-->
            </function>
        </fcs_function>

        <!-- page 137 of manual: mask oxygen supply -->
        <fcs_function name="systems/flight/oxygen-pressure-kPa">
            <function>
                <product>
                    <property>/controls/oxygen</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.1
                              59055.1         0.4 <!--  9000m cabin density alt / 18000m density alt -->
                              85301.8         6.7 <!-- 15000m cabin density alt / 26000m density alt -->
                        </tableData>
                    </table>
                    <table>
                        <independentVar lookup="row">/ja37/systems/oxygen-bottle-pressure</independentVar>
                        <tableData>
                            <!-- kp/cm2 -->
                                 15.0         0.0
                                 40.0         1.0
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/instr/oxygen-manometer-pre">
            <function>
                <product>
                    <property>/ja37/systems/oxygen-bottle-pressure</property>
                    <table>
                        <independentVar lookup="row">/ja37/elec/ac-bus-main-volt</independentVar>
                        <tableData>
                                 99.0         0.0
                                100.0         1.0
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <lag_filter name="systems/flight/instr/oxygen-manometer">
            <input> systems/flight/instr/oxygen-manometer-pre </input>
            <c1> 5 </c1>
            <output> /ja37/systems/oxygen-manometer </output>
        </lag_filter>

        <fcs_function name="systems/flight/environment-pressure-kPa">
            <function>
                <product>
                    <property>atmosphere/P-psf</property>
                    <value>0.047880258888979</value>
                </product>
            </function>
        </fcs_function>

        <!-- page 135 of manual -->
        <fcs_function name="systems/flight/closed-canopy-cabin-pressure-kPa">
            <function>
                <sum>
                    <property>systems/flight/environment-pressure-kPa</property>
                    <table>
                        <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                        <tableData>
                                  0.0         0.0
                               8500.0         0.0
                              16404.2        19.6 <!--  5000m density alt -->
                              65616.8        23.5 <!-- 20000m density alt -->
                        </tableData>
                    </table>
                </sum>
            </function>
        </fcs_function>

        <switch name="systems/flight/cabin-pressure-tmp-kPa">
            <default value="systems/flight/closed-canopy-cabin-pressure-kPa"/>
            <test logic="OR" value="systems/flight/environment-pressure-kPa">
              fcs/canopy/pos-norm ne 0
              fcs/canopy/hinges/serviceable ne 1
            </test>
            <test logic="AND" value="systems/flight/cabin-pressure-tmp-kPa">
              gear/gear-pos-norm == 1
              gear/unit[0]/WOW ne 1
            </test>
        </switch>

        <lag_filter name="systems/flight/cabin-pressure-kPa">
            <input> systems/flight/cabin-pressure-tmp-kPa </input>
            <c1> 0.5 </c1>
        </lag_filter>

        <fcs_function name="systems/flight/cabin-pressure-kpm2">
            <!-- kilopond per square cm2-->
            <function>
                <product>
                    <property>systems/flight/cabin-pressure-kPa</property>
                    <value>0.010197162129779</value>
                </product>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/cabin-diff-pressure-kpm2">
            <!-- kilopond per square cm2-->
            <function>
                <difference>
                    <property>systems/flight/cabin-pressure-kpm2</property>
                    <product>
                        <property>systems/flight/environment-pressure-kPa</property>
                        <value>0.010197162129779</value>
                    </product>
                </difference>
            </function>
        </fcs_function>

        <fcs_function name="systems/flight/brake-pressure-tmp-kpm2">
            <function>
                <product>
                    <or>
                        <property>/controls/gear/brake-left</property>
                        <property>/controls/gear/brake-parking</property>
                    </or>
                    <property>gear/unit[1]/WOW</property>
                    <table>
                        <independentVar lookup="row">forces/fbx-gear-lbs</independentVar>
                        <tableData>
                            -40000         400
                            -30000         300
                                 0         0.0
                             30000         300
                             40000         400
                        </tableData>
                    </table>
                </product>
            </function>
        </fcs_function>

        <lag_filter name="systems/flight/brake-pressure-kpm2">
            <input> systems/flight/brake-pressure-tmp-kpm2 </input>
            <c1> 10 </c1>
        </lag_filter>


        <!-- AJS-37 manual part 2, page 173 -->
        <fcs_function name="systems/flight/rotation-speed">
            <function>
                <table>
                    <independentVar lookup="row">inertia/weight-lbs</independentVar>
                    <independentVar lookup="column">/environment/temperature-degc</independentVar>
                    <tableData>
                        <!-- rotation speed in Km/h at max afterburner -->
                                    -15.0    0.0   15.0   30.0
                        28660.09    122.5  133.0  150.0  167.5
                        33069.34    155.0  165.0  177.5  194.0
                        37478.58    180.0  190.0  202.5  216.0
                        41887.83    200.0  210.0  220.0  232.5
                        <!-- This output is at present not used as it gives about 75% of a sane value.
                             Not sure why. -->
                    </tableData>
                </table>
            </function>
        </fcs_function>
    </channel>
</system>
